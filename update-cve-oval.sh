#!/bin/bash
#
# update-cve-oval.sh
#
# This script updates the CVE dictionary and updates the OVAL copy.
#
# Dependencies (which are installed by running 'install-vuls.sh'):
# go-cve-dictionary: https://github.com/kotakanbe/go-cve-dictionary
# goval-dictionary: https://github.com/kotakanbe/goval-dictionary

set -uo pipefail

readonly __progname="$(basename "$0")"

errx() {
	echo -e "${__progname}: $*" >&2

	exit 1
}

main() {
	[ "${EUID}" -ne 0 ] && \
		errx "need root"

	for cmd in go git gcc go-cve-dictionary; do
		which "${cmd}" >/dev/null || \
			errx "cannot execute '${cmd}'"
	done

	local -r vulsenv="/etc/profile.d/vuls-env.sh"
	echo "${__progname}: sourcing '${vulsenv}'"
	. "${vulsenv}" || \
		errx "cannot open '${vuls}'"

	local -r vulspath="/usr/local/vuls"
	[ ! -d "${vulspath}" ] && \
		errx "cannot open '${vulspath}'"

	cd "${vulspath}"

	local -r curyear="$(date +"%Y")"
	for year in {2004..${curyear}}; do
		echo "${__progname}: go-cve-dictionary fetchnvd -years '${year}'"
		go-cve-dictionary fetchnvd -years "${year}" 2>/dev/null || \
			errx "go-cve-dictionary fetchnvd -year '${year}' failed"
	done

	echo "${__progname}: goval-dictionary fetch-redhat 7"
	goval-dictionary fetch-redhat 7 2>/dev/null || \
		errx "goval-dictionary fetch-redhat 7 failed"

	return 0
}

main

exit $?
